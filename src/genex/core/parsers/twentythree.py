"""Parser for 23andMe raw data files."""

from pathlib import Path
from typing import Iterator, Optional
import re

from ..models import SNP, DataSource, GenomeBuild, AncestrySegment


def detect_23andme(filepath: Path) -> bool:
    """Check if file is a 23andMe raw data file."""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            for line in f:
                if '23andMe' in line or 'This data file generated by 23andMe' in line:
                    return True
                if not line.startswith('#'):
                    break
        return False
    except Exception:
        return False


def detect_genome_build(filepath: Path) -> GenomeBuild:
    """Detect genome build from 23andMe file header."""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            for line in f:
                if 'build 37' in line.lower() or 'grch37' in line.lower():
                    return GenomeBuild.GRCH37
                if 'build 38' in line.lower() or 'grch38' in line.lower():
                    return GenomeBuild.GRCH38
                if not line.startswith('#'):
                    break
        # Default for 23andMe v4/v5
        return GenomeBuild.GRCH37
    except Exception:
        return GenomeBuild.UNKNOWN


def parse_23andme_genome(filepath: Path) -> Iterator[SNP]:
    """
    Parse 23andMe raw genome data file.

    Yields SNP objects for each valid line.

    File format:
    # rsid  chromosome  position  genotype
    rs12345 1           12345     AG
    """
    build = detect_genome_build(filepath)

    with open(filepath, 'r', encoding='utf-8') as f:
        for line in f:
            # Skip comments and empty lines
            if line.startswith('#') or not line.strip():
                continue

            parts = line.strip().split('\t')
            if len(parts) < 4:
                continue

            rsid, chromosome, position, genotype = parts[0], parts[1], parts[2], parts[3]

            # Skip invalid positions
            try:
                pos = int(position)
            except ValueError:
                continue

            yield SNP(
                rsid=rsid,
                chromosome=chromosome,
                position=pos,
                genotype=genotype,
                source=DataSource.TWENTYTHREE_AND_ME,
                build=build,
            )


def count_snps(filepath: Path) -> int:
    """Count total SNPs in file without loading all into memory."""
    count = 0
    with open(filepath, 'r', encoding='utf-8') as f:
        for line in f:
            if not line.startswith('#') and line.strip():
                count += 1
    return count


def parse_ancestry_composition(filepath: Path) -> Iterator[AncestrySegment]:
    """
    Parse 23andMe ancestry composition CSV file.

    File format:
    Ancestry,Copy,Chromosome,Start Point,End Point
    Ashkenazi Jewish,2,chr1,1005806,249210707
    """
    import csv

    with open(filepath, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            try:
                yield AncestrySegment(
                    ancestry=row['Ancestry'],
                    chromosome=row['Chromosome'].replace('chr', ''),
                    start=int(row['Start Point']),
                    end=int(row['End Point']),
                    copy=int(row['Copy']),
                )
            except (KeyError, ValueError):
                continue
